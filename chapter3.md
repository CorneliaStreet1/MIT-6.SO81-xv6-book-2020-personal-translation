# 第三章

# 页表

页表是操作系统用来给每个进程提供其私有的地址空间和内存的的机制。页表确定了地址意味着什么内存，物理内存的哪部分可以被访问。它们使得xv6得以隔离不同进程的地址空间以及在单个硬件上复用它们。页表同样提供了某种程度上间接允许xv6使用一些技巧：将同一部分内存（trampoline page）映射到多个地址空间，以及用未映射的页表监视（guarding）内核和用户栈。本章的剩余部分解释RISC-V硬件提供的页表以及xv6如何使用它们。

## 3.1	页式硬件(paging hardware)

作为复习，RISC-V指令（用户指令以及内核指令）操控的是虚拟地址。机器的RAM，或者说物理内存，是用物理地址编制索引的。RISC-V的页表硬件通过将每个虚拟地址映射到一个物理地址来将这两种地址联系在一起。

xv6基于Sv39 RISC-V运行，这意味着对于一个64位的虚拟地址只有其低位的39位被用到；高25位不被使用。在这种Sv39配置下，一个RISC-V页表逻辑上来说是一个由2^27^个页表项（PTE，`page table entry`）构成的数组。每个PTE包含一个44位的物理分页数（PPN，`physical page number`）以及一些标志。分页硬件通过使用39位的高27位从页表中索引到对应的PTE，然后构造一个56位的物理地址，这个地址的高44位来自页表项的物理分页数，低12位则来自原始的虚拟地址。`Figure3.1`展现了这个过程，图中将页表逻辑上看做是一个简单的页表项数组(`Figure 3.2`有更完整的叙述)。一个页表给操作系统在以连续的4096字节片为粒度上的虚拟到物理的地址翻译控制权。这样的一个分片叫做一页。

在Sv39 RISC-V中，一个虚拟地址的高25位不会被用于地址翻译；在未来，RISC-V 可能会使用这些位来定义更多层次的翻译。物理地址同样有增长空间：在PTE格式中有物理页数再增长10位的空间。

<img src="https://raw.githubusercontent.com/CorneliaStreet1/PictureBed/master/202201301633363.png" alt="image-20220130163344193" style="zoom:50%;" />

正如`Figure3.2`所展示的，实际的翻译分三步发生。一个页表在物理内存中以三层树的形式储存。树的根是一个4096(2^12^)字节的包含512个页表项的页表分页，这些页表项中保存了树的下一层的各个页表分页的物理地址。每一个分页包含了512个为树的最后一层准备的页表项。分页硬件使用27位中的高9位选择在根分页的一个页表项，中间9位选择下一层的分页的页表项，最低9位选择最后一层分页的页表项。
